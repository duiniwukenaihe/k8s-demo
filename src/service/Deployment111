package service

import (
	"context"
	"fmt"
	"github.com/gin-gonic/gin"
	"k8s-demo1/src/common"
	"k8s-demo1/src/core"
	. "k8s-demo1/src/lib"
	v1 "k8s.io/api/apps/v1"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

type Deployment struct {
	Namespace           string
	Name                string
	Replicas            int32
	AvailableReplicas   int32
	UnavailableReplicas int32
	Images              string
	CreateTime          string
	Labels              map[string]string
	Pods                []*Pod
}

func ListDeployment(g *gin.Context) {
	ns := g.Query("ns")
	deplist, err := core.DepMap.ListByNS(ns)
	//dps, err := K8sClient.AppsV1().Deployments(ns).List(context.Background(), metav1.ListOptions{})
	if err != nil {
		g.Error(err)
	}
	ret := make([]*Deployment, 0)
	for _, item := range deplist {
		ret = append(ret, &Deployment{
			Namespace:           item.Namespace,
			Name:                item.Name,
			Replicas:            item.Status.Replicas,
			AvailableReplicas:   item.Status.AvailableReplicas,
			UnavailableReplicas: item.Status.UnavailableReplicas,
			Images:              item.Spec.Template.Spec.Containers[0].Image,
			Labels:              item.GetLabels(),
			Pods:                GetPodsByDep(ns, item),
		})

	}
	g.JSON(200, ret)
	return
}

func GetDeployment(g *gin.Context) {
	ns := g.Query("ns")
	name := g.Query("name")
	ctx := context.Background()
	getopt := metav1.GetOptions{}
	dps, err := K8sClient.AppsV1().Deployments(ns).Get(ctx, name, getopt)
	if err != nil {
		fmt.Println(err)
	}
	ret := make([]*Deployment, 0)
	ret = append(ret, &Deployment{
		Namespace:           dps.Namespace,
		Name:                dps.Name,
		Replicas:            dps.Status.Replicas,
		AvailableReplicas:   dps.Status.AvailableReplicas,
		UnavailableReplicas: dps.Status.UnavailableReplicas,
		Images:              dps.Spec.Template.Spec.Containers[0].Image,
		CreateTime:          dps.CreationTimestamp.Format("2006-01-02 15:03:04"),
		Labels:              dps.Labels,
		Pods:                GetPodsByDep(ns, dps),
	})
	fmt.Println(ret)
	return
}
func GetLabels(m map[string]string) string {
	labels := ""
	// aa=xxx,xxx=xx
	for k, v := range m {
		if labels != "" {
			labels += ","
		}
		labels += fmt.Sprintf("%s=%s", k, v)
	}
	return labels
}
func GetPodsByDep(ns string, dep *v1.Deployment) []*Pod {
	ctx := context.Background()
	listopt := metav1.ListOptions{
		LabelSelector: common.GetRsLableByDeployment(dep),
	}
	list, err := K8sClient.CoreV1().Pods(ns).List(ctx, listopt)
	if err != nil {
		panic(err.Error())
	}
	pods := make([]*Pod, len(list.Items))
	for i, pod := range list.Items {
		pods[i] = &Pod{
			Namespace:  pod.Namespace,
			Name:       pod.Name, //获取 pod名称
			Status:     string(pod.Status.Phase),
			Images:     pod.Spec.Containers[0].Image,
			NodeName:   pod.Spec.NodeName, //所属节点
			Labels:     pod.Labels,
			CreateTime: pod.CreationTimestamp.Format("2006-01-02 15:04:05"), //创建时间
		}
	}

	return pods

}
func GetPodsByDep1(ns string, dep *v1.Deployment) []*Pod {
	ctx := context.Background()
	listopt := metav1.ListOptions{
		LabelSelector: GetLabels(dep.Spec.Selector.MatchLabels),
	}
	list, err := K8sClient.CoreV1().Pods(ns).List(ctx, listopt)
	if err != nil {
		panic(err.Error())
	}
	pods := make([]*Pod, len(list.Items))
	for i, pod := range list.Items {
		pods[i] = &Pod{
			Namespace:  pod.Namespace,
			Name:       pod.Name, //获取 pod名称
			Status:     string(pod.Status.Phase),
			Images:     pod.Spec.Containers[0].Image,
			NodeName:   pod.Spec.NodeName, //所属节点
			Labels:     pod.Labels,
			CreateTime: pod.CreationTimestamp.Format("2006-01-02 15:04:05"), //创建时间
		}
	}

	return pods

}
func GetDeployment1(g *gin.Context) {
	ns := g.Query("ns")
	name := g.Query("name")
	ctx := context.Background()
	getopt := metav1.GetOptions{}
	dps, err := K8sClient.AppsV1().Deployments(ns).Get(ctx, name, getopt)
	if err != nil {
		g.Error(err)
	}
	ret := make([]*Deployment, 0)
	ret = append(ret, &Deployment{
		Namespace:           dps.Namespace,
		Name:                dps.Name,
		Replicas:            dps.Status.Replicas,
		AvailableReplicas:   dps.Status.AvailableReplicas,
		UnavailableReplicas: dps.Status.UnavailableReplicas,
		Images:              dps.Spec.Template.Spec.Containers[0].Image,
		CreateTime:          dps.CreationTimestamp.Format("2006-01-02 15:03:04"),
		Labels:              dps.Labels,
		Pods:                GetPodsByDep(ns, dps),
	})
	g.JSON(200, ret)
	return
}
